<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Spotify Downloader Pro</title>
  <style>
    /* ====== THEME / RESET ====== */
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary-green:#1DB954;--dark-green:#1ed760;--bg-primary:#0d1117;--bg-secondary:#161b22;
      --glass-bg:rgba(255,255,255,.05);--glass-border:rgba(255,255,255,.1);
      --text-primary:#f0f6fc;--text-secondary:#8b949e;--accent-purple:#8b5cf6;--accent-blue:#3b82f6
    }
    body{background:linear-gradient(135deg,#0d1117 0%,#161b22 50%,#21262d 100%);color:var(--text-primary);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto',sans-serif;min-height:100vh}
    header{background:rgba(29,185,84,.1);backdrop-filter:blur(20px);border-bottom:1px solid var(--glass-border);padding:2rem 0;text-align:center}
    .logo{font-size:3rem;font-weight:800;background:linear-gradient(135deg,#1DB954,#1ed760,#3b82f6);background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:.5rem}
    .tagline{color:var(--text-secondary);font-size:1.1rem;font-weight:300}
    .container{max-width:800px;margin:0 auto;padding:3rem 2rem}
    .search-section{background:var(--glass-bg);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:24px;padding:2.5rem;margin-bottom:3rem;box-shadow:0 8px 32px rgba(0,0,0,.3)}
    .input-container{position:relative;margin-bottom:1.5rem}
    .search-input{width:100%;padding:1.2rem 1.5rem 1.2rem 3.5rem;background:rgba(255,255,255,.05);border:2px solid transparent;border-radius:16px;color:var(--text-primary);font-size:1.1rem;transition:all .3s ease}
    .search-input:focus{outline:none;border-color:var(--primary-green);background:rgba(255,255,255,.08)}
    .search-icon{position:absolute;left:1.2rem;top:50%;transform:translateY(-50%);color:var(--text-secondary);font-size:1.2rem}
    .search-btn{background:linear-gradient(135deg,var(--primary-green),var(--dark-green));color:#fff;border:none;padding:1.2rem 2.5rem;border-radius:16px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all .3s ease}
    .search-btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(29,185,84,.4)}
    .loading{display:none;text-align:center;padding:2rem;color:var(--text-secondary)}
    .loading.active{display:block}
    .spinner{width:40px;height:40px;border:3px solid var(--glass-border);border-top:3px solid var(--primary-green);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 1rem}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .results{opacity:0;transition:opacity .5s ease}
    .results.visible{opacity:1}
    .song-card{background:var(--glass-bg);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:20px;padding:1.8rem;margin-bottom:1.5rem;transition:all .3s ease}
    .song-card:hover{transform:translateY(-5px);border-color:rgba(29,185,84,.3);box-shadow:0 15px 30px rgba(0,0,0,.3)}
    .song-info{display:flex;align-items:center;margin-bottom:1.5rem}
    .song-avatar{width:60px;height:60px;background:linear-gradient(135deg,var(--primary-green),var(--accent-purple));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;margin-right:1rem;overflow:hidden;position:relative}
    .song-avatar img{width:100%;height:100%;object-fit:cover;border-radius:12px}
    .song-details h3{font-size:1.3rem;font-weight:700;margin-bottom:.3rem;color:var(--text-primary)}
    .song-details p{color:var(--text-secondary);font-size:1rem}
    .song-actions{display:flex;gap:1rem;flex-wrap:wrap}
    .action-btn{background:rgba(255,255,255,.05);border:1px solid var(--glass-border);color:var(--text-primary);padding:.8rem 1.5rem;border-radius:12px;cursor:pointer;font-weight:500;transition:all .3s ease;display:flex;align-items:center;gap:.5rem}
    .download-btn{background:linear-gradient(135deg,var(--primary-green),var(--dark-green));border-color:var(--primary-green)}
    .action-btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.2)}
    .action-btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .download-queue{position:fixed;top:20px;right:20px;width:350px;max-height:70vh;background:var(--glass-bg);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:20px;padding:1.5rem;transform:translateX(400px);transition:all .3s ease;z-index:1000;box-shadow:0 20px 40px rgba(0,0,0,.3)}
    .download-queue.visible{transform:translateX(0)}
    .queue-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;padding-bottom:1rem;border-bottom:1px solid var(--glass-border)}
    .queue-title{font-size:1.2rem;font-weight:700;color:var(--text-primary);display:flex;align-items:center;gap:.5rem}
    .queue-close{background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:1.5rem;padding:.5rem;border-radius:8px;transition:all .3s ease}
    .queue-close:hover{color:var(--text-primary);background:rgba(255,255,255,.1)}
    .queue-items{max-height:400px;overflow-y:auto}
    .queue-item{background:rgba(255,255,255,.03);border:1px solid var(--glass-border);border-radius:12px;padding:1rem;margin-bottom:.8rem}
    .queue-item.completed{border-color:rgba(29,185,84,.3);background:rgba(29,185,84,.1)}
    .queue-item.failed{border-color:rgba(239,68,68,.3);background:rgba(239,68,68,.1)}
    .queue-item-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:.8rem}
    .queue-song-info h4{font-size:.9rem;font-weight:600;color:var(--text-primary);margin-bottom:.2rem}
    .queue-song-info p{font-size:.8rem;color:var(--text-secondary)}
    .queue-status{font-size:1.2rem}
    .queue-toggle{position:fixed;top:20px;right:20px;background:linear-gradient(135deg,var(--primary-green),var(--dark-green));color:#fff;border:none;width:60px;height:60px;border-radius:50%;cursor:pointer;font-size:1.5rem;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 25px rgba(29,185,84,.3);transition:all .3s ease;z-index:1001}
    .queue-toggle:hover{transform:scale(1.1)}
    .queue-badge{position:absolute;top:-5px;right:-5px;background:#ef4444;color:#fff;font-size:.8rem;font-weight:700;min-width:20px;height:20px;border-radius:10px;display:flex;align-items:center;justify-content:center;transform:scale(0);transition:all .3s ease}
    .queue-badge.visible{transform:scale(1)}
    .empty-queue{text-align:center;padding:2rem 1rem;color:var(--text-secondary)}
    .empty-queue-icon{font-size:2.5rem;margin-bottom:1rem;opacity:.5}
    .no-results{text-align:center;padding:3rem 2rem;color:var(--text-secondary);background:var(--glass-bg);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:20px}
    .no-results-icon{font-size:3rem;margin-bottom:1rem;opacity:.5}
    @media (max-width:768px){
      .container{padding:2rem 1rem}
      .search-section{padding:2rem}
      .song-actions{flex-direction:column}
      .action-btn{justify-content:center}
      .download-queue{width:calc(100vw - 40px);right:20px;left:20px;transform:translateY(100vh)}
      .download-queue.visible{transform:translateY(0)}
      .queue-toggle{bottom:20px;top:auto}
    }
  </style>
</head>
<body>
  <!-- Download Queue Toggle -->
  <button class="queue-toggle" onclick="toggleQueue()" id="queueToggle">üì•
    <span class="queue-badge" id="queueBadge">0</span>
  </button>

  <!-- Download Queue Panel -->
  <div class="download-queue" id="downloadQueue">
    <div class="queue-header">
      <div class="queue-title"><span>üì•</span><span>Download Queue</span></div>
      <button class="queue-close" onclick="toggleQueue()">√ó</button>
    </div>
    <div class="queue-items" id="queueItems">
      <div class="empty-queue">
        <div class="empty-queue-icon">üéµ</div>
        <p>No downloads yet</p>
        <small>Downloaded songs will appear here</small>
      </div>
    </div>
  </div>

  <header>
    <div class="header-content">
      <h1 class="logo">üéµ Spotify Pro</h1>
      <p class="tagline">Premium Music Downloader Experience</p>
    </div>
  </header>

  <div class="container">
    <div class="search-section">
      <div class="input-container">
        <input id="songInput" class="search-input" placeholder="Search for your favorite songs..." />
        <span class="search-icon">üîç</span>
      </div>
      <button class="search-btn" onclick="searchSong()"><span>Search Now</span></button>
    </div>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Searching for amazing music...</p>
    </div>

    <div id="results" class="results"></div>
  </div>

  <script>
    // POINT THIS TO YOUR LIVE BACKEND
    const backendUrl = "https://server-muddy-dream-414.fly.dev";

    let downloadQueue = [];
    let queueVisible = false;
    let searchTimeout = null;

    // ---------- Helpers ----------
    function escapeHtml(s = "") {
      return s.replace(/[&<>"']/g, c => (
        { "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;" }[c]
      ));
    }

    function toggleQueue() {
      const panel = document.getElementById("downloadQueue");
      queueVisible = !queueVisible;
      panel.classList.toggle("visible", queueVisible);
    }

    function updateQueueBadge() {
      const badge = document.getElementById("queueBadge");
      const active = downloadQueue.filter(i => i.status === "downloading" || i.status === "pending").length;
      badge.textContent = active;
      badge.classList.toggle("visible", active > 0);
    }

    function addToQueue(songName, artist, url) {
      const item = { id: Date.now() + Math.random(), songName, artist, url, status: "pending" };
      downloadQueue.unshift(item);
      updateQueueDisplay();
      updateQueueBadge();
      return item.id;
    }

    function setQueueStatus(id, status) {
      const it = downloadQueue.find(x => x.id === id);
      if (it) { it.status = status; updateQueueDisplay(); updateQueueBadge(); }
    }

    function updateQueueDisplay() {
      const box = document.getElementById("queueItems");
      if (!downloadQueue.length) {
        box.innerHTML = `
          <div class="empty-queue">
            <div class="empty-queue-icon">üéµ</div>
            <p>No downloads yet</p>
            <small>Downloaded songs will appear here</small>
          </div>`;
        return;
      }
      box.innerHTML = downloadQueue.map(item => {
        const cls = item.status === "completed" ? "completed" : item.status === "failed" ? "failed" : "";
        const icon = item.status === "completed" ? "‚úÖ" : item.status === "failed" ? "‚ùå" : item.status === "downloading" ? "‚¨áÔ∏è" : "‚è≥";
        return `
          <div class="queue-item ${cls}">
            <div class="queue-item-header">
              <div class="queue-song-info">
                <h4>${escapeHtml(item.songName)}</h4>
                <p>by ${escapeHtml(item.artist)}</p>
              </div>
              <div class="queue-status">${icon}</div>
            </div>
          </div>`;
      }).join("");
    }

    function filenameFromDisposition(h) {
      // Try RFC5987 or basic filename=
      if (!h) return null;
      const utf = /filename\*\=([^']*)''([^;]+)/i.exec(h);
      if (utf && utf[2]) return decodeURIComponent(utf[2]);
      const basic = /filename\=\"?([^\";]+)\"?/i.exec(h);
      return basic ? basic[1] : null;
    }

    function normalizeSong(item) {
      // Accept multiple shapes from backend
      const title = item.title || item.name || item.track || "Unknown Title";
      const artist = item.artist || item.artists || item.author || "Unknown Artist";
      const artwork = item.artwork || item.artwork_url || item.thumbnail || item.image || null;
      const url = item.url || item.spotify_url || item.permalink || item.link || null; // ideally a Spotify track URL or a good search string
      const album = item.album || "";
      return { title, artist, artwork, url, album, raw: item };
    }

    function cardHtml(song) {
      return `
        <div class="song-card">
          <div class="song-info">
            <div class="song-avatar">
              ${song.artwork ? `<img src="${escapeHtml(song.artwork)}" alt="artwork" />` : "üéµ"}
            </div>
            <div class="song-details">
              <h3>${escapeHtml(song.title)}</h3>
              <p>${escapeHtml(song.artist)}</p>
            </div>
          </div>
          <div class="song-actions">
            <button class="action-btn download-btn" onclick='downloadSong(${JSON.stringify(song).replace(/'/g,"&#39;")})'>
              ‚¨áÔ∏è Download
            </button>
            ${song.url ? `<button class="action-btn" onclick="navigator.clipboard.writeText('${escapeHtml(song.url)}')">üîó Copy Link</button>` : ""}
          </div>
        </div>
      `;
    }

    // ---------- Search ----------
    async function searchSong() {
      const q = document.getElementById("songInput").value.trim();
      const loading = document.getElementById("loading");
      const resultsDiv = document.getElementById("results");

      resultsDiv.innerHTML = "";
      resultsDiv.classList.remove("visible");

      if (!q) {
        resultsDiv.innerHTML = `<div class="no-results"><div class="no-results-icon">üîé</div><p>Please enter a song name to start searching üéµ</p></div>`;
        resultsDiv.classList.add("visible");
        return;
      }

      loading.classList.add("active");
      try {
        const res = await fetch(`${backendUrl}/search`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query: q })
        });
        if (!res.ok) throw new Error(`Server error: ${res.status}`);

        const payload = await res.json();
        const list = Array.isArray(payload) ? payload : (Array.isArray(payload.results) ? payload.results : []);
        if (!list.length) {
          resultsDiv.innerHTML = `<div class="no-results"><div class="no-results-icon">ü§î</div><p>No songs found. Try a different search term.</p></div>`;
          resultsDiv.classList.add("visible");
          return;
        }

        const songs = list.map(normalizeSong);
        resultsDiv.innerHTML = songs.map(cardHtml).join("");
        resultsDiv.classList.add("visible");
      } catch (e) {
        resultsDiv.innerHTML = `<div class="no-results"><div class="no-results-icon">‚ö†Ô∏è</div><p>Connection error: ${escapeHtml(e.message)}</p></div>`;
        resultsDiv.classList.add("visible");
      } finally {
        loading.classList.remove("active");
      }
    }

    // ---------- Download ----------
    async function downloadSong(song) {
      const title = song.title || "Track";
      const artist = song.artist || "Unknown Artist";
      // Prefer passing a Spotify track URL if we have it; otherwise pass "Artist - Title"
      const queryOrUrl = song.url || `${artist} - ${title}`;

      const id = addToQueue(title, artist, queryOrUrl);
      setQueueStatus(id, "downloading");

      try {
        const res = await fetch(`${backendUrl}/download?url=${encodeURIComponent(queryOrUrl)}`, {
          method: "GET"
        });
        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          throw new Error(`Download failed (${res.status}): ${txt || "server error"}`);
        }

        const blob = await res.blob();
        // Determine filename
        const disp = res.headers.get("Content-Disposition");
        let fname = filenameFromDisposition(disp);
        if (!fname) {
          const safeArtist = artist.replace(/[\\/:*?"<>|]/g, "_");
          const safeTitle  = title.replace(/[\\/:*?"<>|]/g, "_");
          fname = `${safeArtist} - ${safeTitle}.mp3`;
        }

        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = fname;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(a.href), 2000);

        setQueueStatus(id, "completed");
      } catch (e) {
        console.error(e);
        setQueueStatus(id, "failed");
        alert(`‚ùå ${title}: ${e.message}`);
      }
    }

    // ---------- Init / UX ----------
    function init() {
      const input = document.getElementById("songInput");
      input.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          clearTimeout(searchTimeout);
          searchSong();
        }
      });
      input.addEventListener("input", (e) => {
        clearTimeout(searchTimeout);
        const q = e.target.value.trim();
        if (q.length >= 3) {
          searchTimeout = setTimeout(searchSong, 600);
        } else if (q.length === 0) {
          const resultsDiv = document.getElementById("results");
          resultsDiv.innerHTML = "";
          resultsDiv.classList.remove("visible");
        }
      });
    }
    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
